<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Balada Segura - Registro de Abordagens</title>
        <script src="crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(31, 38, 135, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e8f4f8;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(45deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .hidden {
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-active {
            color: #4ade80;
            font-weight: bold;
        }

        .status-inactive {
            color: #f87171;
            font-weight: bold;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .table-responsive {
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
        }

        .location-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
                margin: 10px 0;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .navbar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 10px;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .export-section {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2);">
        <p style="font-size: 12px; font-style: italic; color: #a8e6cf; margin: 0;">Leandro Abranti Developer</p>
    </div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöî Sistema Balada Segura</h1>
            <p>Registro de Abordagens de Tr√¢nsito</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <h2 style="text-align: center; margin-bottom: 30px;">üîê Acesso ao Sistema</h2>
            <div class="form-group">
                <label for="matricula">Matr√≠cula:</label>
                <input type="text" id="matricula" placeholder="Digite sua matr√≠cula">
            </div>
            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" placeholder="Digite sua senha (primeiro acesso: crie sua senha)">
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="login()">Entrar</button>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 14px;">
                <h4 style="margin-bottom: 10px;">‚ÑπÔ∏è Instru√ß√µes de Acesso:</h4>
                <p>‚Ä¢ <strong>Primeiro acesso:</strong> Digite sua matr√≠cula e crie uma senha de pelo menos 6 caracteres</p>
                <p>‚Ä¢ <strong>Acessos seguintes:</strong> Use sua matr√≠cula e senha j√° definida</p>
                <p>‚Ä¢ <strong>Matr√≠culas autorizadas:</strong> 257 (Admin), 100, 101</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="navbar">
                <div class="user-info">
                    <span id="userInfo" class="badge"></span>
                    <span id="eventStatus" class="badge"></span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Sair</button>
            </div>

            <!-- Admin Panel -->
            <div id="adminPanel" class="hidden">
                <!-- Estat√≠sticas -->
                <div id="statsSection" class="grid">
                    <div class="stats-card">
                        <div class="stats-number" id="totalUsuarios">0</div>
                        <div>Usu√°rios Cadastrados</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalEventos">0</div>
                        <div>Eventos Criados</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number" id="totalAbordagens">0</div>
                        <div>Total de Abordagens</div>
                    </div>
                </div>

                <div class="grid">
                    <!-- Gerenciar Usu√°rios -->
                    <div class="card">
                        <h3>üë• Gerenciar Usu√°rios</h3>
                        <div class="form-group">
                            <label>Nova Matr√≠cula:</label>
                            <input type="text" id="novaMatricula" placeholder="Digite a matr√≠cula">
                        </div>
                        <p style="color: #e8f4f8; font-size: 14px; margin: 10px 0;">
                            üí° O usu√°rio definir√° sua pr√≥pria senha no primeiro acesso ao sistema.
                        </p>
                        <button class="btn btn-success" onclick="cadastrarUsuario()">Cadastrar Usu√°rio</button>
                        <div id="usuariosList" class="table-responsive" style="margin-top: 20px;"></div>
                    </div>

                    <!-- Criar Evento Blitz -->
                    <div class="card">
                        <h3>üö® Criar Evento Blitz</h3>
                        <div class="form-group">
                            <label>Nome da Blitz:</label>
                            <input type="text" id="nomeBlitz" value="Balada Segura" readonly>
                        </div>
                        <div class="form-group">
                            <label>Data:</label>
                            <input type="date" id="dataBlitz">
                        </div>
                        <div class="form-group">
                            <label>Hora:</label>
                            <input type="time" id="horaBlitz">
                        </div>
                        <button class="btn btn-primary" onclick="obterLocalizacao()">üìç Obter Localiza√ß√£o Atual</button>
                        <div id="localizacaoInfo" class="location-info hidden"></div>
                        <div class="form-group">
                            <label>Local (manual):</label>
                            <input type="text" id="localBlitz" placeholder="Ou digite o local manualmente">
                        </div>
                        <div class="form-group">
                            <label>Matr√≠culas Participantes:</label>
                            <div id="matriculasDisponiveis" class="checkbox-group"></div>
                        </div>
                        <button class="btn btn-success" onclick="criarEvento()">Criar Evento</button>
                    </div>
                </div>

                <!-- Eventos Ativos -->
                <div class="card">
                    <h3>üìã Eventos Ativos</h3>
                    <div id="eventosAtivos" class="table-responsive"></div>
                </div>

                <!-- Relat√≥rios -->
                <div class="card export-section">
                    <h3>üìä Relat√≥rios</h3>
                    <button class="btn btn-warning" onclick="exportarRelatorio()">Exportar Relat√≥rio do Evento Atual</button>
                    <button class="btn btn-primary" onclick="exportarRelatorioCompleto()">Exportar Relat√≥rio Completo</button>
                </div>
            </div>

            <!-- User Panel -->
            <div id="userPanel" class="hidden">
                <div class="card">
                    <h3>üìù Registrar Abordagem</h3>
                    <div id="eventoAtualInfo" class="location-info"></div>
                    
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label>Placa do Ve√≠culo:</label>
                                <input type="text" id="placaVeiculo" placeholder="AAA-0000" style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label>CPF do Condutor:</label>
                                <input type="text" id="cpfCondutor" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label>CNH do Condutor:</label>
                                <input type="text" id="cnhCondutor" placeholder="N√∫mero da CNH">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Foi autuado?</label>
                                <select id="foiAutuado" onchange="toggleAutuacao()">
                                    <option value="nao">N√£o</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Teste do etil√¥metro:</label>
                                <select id="testeEtilometro" onchange="toggleRecusaTeste()">
                                    <option value="nao_realizado">N√£o realizado</option>
                                    <option value="realizado_negativo">Realizado - Negativo</option>
                                    <option value="realizado_positivo">Realizado - Positivo</option>
                                    <option value="recusou">Recusou o teste</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ve√≠culo removido?</label>
                                <select id="veiculoRemovido">
                                    <option value="nao">N√£o</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="artigosSection" class="hidden">
                        <div class="form-group">
                            <label>Artigos do CTB aplicados:</label>
                            <div id="artigosCTB" class="checkbox-group"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <textarea id="observacoes" rows="4" placeholder="Digite observa√ß√µes adicionais..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="registrarAbordagem()">‚úÖ Registrar Abordagem</button>
                </div>

                <!-- Abordagens Registradas -->
                <div class="card">
                    <h3>üìä Abordagens do Evento Atual</h3>
                    <div id="abordagensLista" class="table-responsive"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados do sistema (simulando banco de dados)
        let sistemaData = {
            usuarios: {},
            eventos: [],
            abordagens: [],
            eventoAtivo: null,
            usuarioLogado: null,
            localizacaoAtual: null
        };

        // Matr√≠culas autorizadas no sistema
        const matriculasAutorizadas = {
            '257': { isAdmin: true, nome: 'Administrador' },
            '100': { isAdmin: false, nome: 'Operador 1' },
            '101': { isAdmin: false, nome: 'Operador 2' }
        };

        // Fun√ß√£o para inicializar usu√°rios base (sem senhas)
        function inicializarUsuariosBase() {
            // Verificar se j√° foram inicializados
            if (Object.keys(sistemaData.usuarios).length > 0) {
                console.log('üë• Usu√°rios j√° inicializados.');
                return;
            }

            // Verificar se existe configura√ß√£o manual do admin no localStorage
            const adminManual = localStorage.getItem('adminConfigurado');
            if (adminManual) {
                console.log('üëë Administrador j√° foi configurado manualmente.');
                return;
            }

            // Criar registros base para matr√≠culas autorizadas (sem senha)
            for (let matricula in matriculasAutorizadas) {
                const config = matriculasAutorizadas[matricula];
                sistemaData.usuarios[matricula] = {
                    senha: null, // Sem senha inicial
                    ativo: true,
                    isAdmin: config.isAdmin,
                    primeiroAcesso: true,
                    nome: config.nome,
                    criadoEm: new Date(),
                    criadoPor: 'sistema'
                };
            }

            console.log('‚úÖ Sistema inicializado. Usu√°rios devem definir senhas no primeiro acesso.');
        }

        // Fun√ß√£o para configurar usu√°rio administrador manualmente (para usar ap√≥s definir senha)
        function configurarAdminManual(matricula, senha) {
            const senhaHash = CryptoJS.SHA256(senha).toString();
            sistemaData.usuarios[matricula] = {
                senha: senhaHash,
                ativo: true,
                isAdmin: true,
                primeiroAcesso: false, // Senha j√° foi definida
                criadoEm: new Date(),
                criadoPor: 'manual',
                senhaAlteradaEm: new Date()
            };
            
            // Marcar que o admin foi configurado manualmente
            localStorage.setItem('adminConfigurado', 'true');
            console.log(`‚úÖ Administrador ${matricula} configurado manualmente.`);
            
            // Salvar imediatamente para evitar perda de dados
            salvarDados();
            
            return true;
        }
        
        // Fun√ß√£o para configurar admin manualmente via interface (para produ√ß√£o)
        function configurarAdminManualmente() {
            const matricula = prompt('üîê Digite a matr√≠cula do administrador:');
            if (!matricula) return;
            
            const senha = prompt('üîë Digite a senha do administrador:');
            if (!senha || senha.length < 6) {
                alert('‚ùå A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            
            const confirmaSenha = prompt('üîë Confirme a senha:');
            if (senha !== confirmaSenha) {
                alert('‚ùå As senhas n√£o coincidem!');
                return;
            }
            
            const nome = prompt('üë§ Digite o nome do administrador:') || `Admin ${matricula}`;
            const senhaHash = CryptoJS.SHA256(senha).toString();
            
            // Adicionar usu√°rio admin
            sistemaData.usuarios[matricula] = {
                senha: senhaHash,
                ativo: true,
                isAdmin: true,
                primeiroAcesso: false,
                nome: nome,
                criadoEm: new Date(),
                criadoPor: 'configuracao_manual',
                senhaDefinidaEm: new Date()
            };
            
            // Marcar que o admin foi configurado manualmente
            localStorage.setItem('adminConfigurado', 'true');
            
            // Salvar imediatamente para evitar perda de dados
            salvarDados();
            
            alert(`‚úÖ Administrador configurado com sucesso!\n\nMatr√≠cula: ${matricula}\nNome: ${nome}`);
        }

        // Fun√ß√£o para gerar senha tempor√°ria segura
        function gerarSenhaTemporaria() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let senha = '';
            for (let i = 0; i < 8; i++) {
                senha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return senha;
        }

        // Fun√ß√£o para inicializar usu√°rios padr√£o com senhas tempor√°rias
        function inicializarUsuariosPadrao() {
            // Verificar se j√° foram inicializados (se o sistema j√° tem usu√°rios cadastrados)
            if (Object.keys(sistemaData.usuarios).length > 0) {
                console.log('üë• Usu√°rios j√° inicializados anteriormente.');
                return;
            }

            // Verificar se existe configura√ß√£o manual do admin no localStorage
            const adminManual = localStorage.getItem('adminConfigurado');
            if (adminManual) {
                console.log('üëë Administrador j√° foi configurado manualmente.');
                return;
            }

            const usuariosPadrao = [
                { matricula: '257', isAdmin: true },
                { matricula: '100', isAdmin: false },
                { matricula: '101', isAdmin: false }
            ];

            console.log('üîê Inicializando senhas de primeiro acesso:');
            usuariosPadrao.forEach(user => {
                const senhaTemp = gerarSenhaTemporaria();
                const senhaHash = CryptoJS.SHA256(senhaTemp).toString();
                
                sistemaData.usuarios[user.matricula] = {
                    senha: senhaHash,
                    ativo: true,
                    isAdmin: user.isAdmin,
                    primeiroAcesso: true,
                    senhaTemporaria: senhaTemp,
                    criadoEm: new Date(),
                    criadoPor: 'sistema'
                };
                
                console.log(`üìã Matr√≠cula ${user.matricula}: ${senhaTemp}`);
            });
            
            console.log('‚ö†Ô∏è IMPORTANTE: Anote essas senhas! Elas n√£o ser√£o exibidas novamente.');
            console.log('üí° No primeiro login, ser√° solicitada a troca da senha.');
            
            // Exibir alerta com as credenciais iniciais apenas na primeira vez
            const credenciais = usuariosPadrao.map(user => 
                `Matr√≠cula ${user.matricula}: ${sistemaData.usuarios[user.matricula].senhaTemporaria}`
            ).join('\n');
            
            alert(`üîê CREDENCIAIS DE PRIMEIRO ACESSO\n\n${credenciais}\n\n‚ö†Ô∏è IMPORTANTE:\n‚Ä¢ Anote essas senhas tempor√°rias\n‚Ä¢ Ser√° obrigat√≥rio trocar no primeiro login\n‚Ä¢ Esta mensagem n√£o aparecer√° novamente`);
        }

        // Artigos do CTB que geram multas
        const artigosCTB = {
            '161': 'Estacionar ou parar em local/hor√°rio proibido por sinaliza√ß√£o',
            '162': 'Parar ou estacionar ve√≠culo na pista de rolamento das estradas',
            '163': 'Transitar em marcha √† r√©, salvo na dist√¢ncia necess√°ria',
            '165': 'Dirigir amea√ßando pedestres ou ve√≠culos',
            '165-A': 'Recusar-se a ser submetido a teste do etil√¥metro',
            '169': 'Dirigir sem aten√ß√£o ou sem cuidados indispens√°veis',
            '170': 'Dirigir amea√ßando outros ve√≠culos',
            '171': 'Usar equipamento que prejudique a audi√ß√£o',
            '173': 'Disputar corrida por esp√≠rito de emula√ß√£o',
            '174': 'Promover ou participar de competi√ß√£o esportiva',
            '175': 'Utilizar-se das vias para demonstrar ou exibir manobras perigosas',
            '176': 'Efetuar convers√£o proibida pela sinaliza√ß√£o',
            '177': 'Estacionar na contram√£o de dire√ß√£o',
            '178': 'Estacionar afastado da guia da cal√ßada',
            '179': 'Estacionar em desacordo com a regulamenta√ß√£o',
            '180': 'Parar em local proibido pela sinaliza√ß√£o',
            '181': 'Estacionar em locais e hor√°rios proibidos',
            '192': 'Transitar em velocidade superior √† m√°xima permitida at√© 20%',
            '201': 'Deixar de guardar dist√¢ncia lateral de ve√≠culos',
            '203': 'Ultrapassar pela contram√£o em locais proibidos',
            '208': 'Avan√ßar o sinal vermelho do sem√°foro',
            '209': 'Transitar sobre cal√ßadas, passeios ou canteiros',
            '218': 'Transitar em velocidade superior √† m√°xima permitida de 20% a 50%',
            '219': 'Transitar em velocidade superior √† m√°xima permitida acima de 50%',
            '230': 'Conduzir ve√≠culo com CNH ou PPD cassados',
            '244': 'Conduzir motocicleta, motoneta e ciclomotor sem capacete',
            '252': 'Dirigir ve√≠culo com defeito no sistema de ilumina√ß√£o',
            '253': 'Dirigir ve√≠culo que n√£o ofere√ßa seguran√ßa',
            '254': 'Conduzir ve√≠culo com equipamento obrigat√≥rio ineficiente',
            '255': 'Conduzir ve√≠culo com equipamento obrigat√≥rio violado',
            '261': 'Acionar buzina em local ou hor√°rio proibido',
            '277': 'Deixar de reduzir velocidade quando se aproximar de passagem de n√≠vel',
            '306': 'Avan√ßar sinal vermelho do sem√°foro ou de parada obrigat√≥ria',
            '307': 'Desobedecer √†s ordens emanadas da autoridade competente de tr√¢nsito'
        };

        // Fun√ß√£o de login
        function login() {
            const matricula = document.getElementById('matricula').value.trim();
            const senha = document.getElementById('senha').value.trim();

            if (!matricula) {
                alert('‚ùå Digite sua matr√≠cula!');
                return;
            }

            // Verificar se a matr√≠cula √© autorizada
            if (!matriculasAutorizadas[matricula]) {
                alert('‚ùå Matr√≠cula n√£o autorizada no sistema!');
                return;
            }

            const usuario = sistemaData.usuarios[matricula];

            // Se √© primeiro acesso (usu√°rio n√£o tem senha definida)
            if (!usuario || usuario.senha === null || usuario.primeiroAcesso) {
                if (!senha) {
                    alert('üîê PRIMEIRO ACESSO\n\nDefina sua senha para acessar o sistema.');
                    return;
                }

                if (senha.length < 6) {
                    alert('‚ùå A senha deve ter pelo menos 6 caracteres!');
                    return;
                }

                const confirmaSenha = prompt('üîë Confirme sua nova senha:');
                if (senha !== confirmaSenha) {
                    alert('‚ùå As senhas n√£o coincidem!');
                    return;
                }

                // Criar ou atualizar usu√°rio com a nova senha
                const senhaHash = CryptoJS.SHA256(senha).toString();
                const config = matriculasAutorizadas[matricula];
                
                // Preservar dados existentes do usu√°rio se houver
                const dadosUsuario = usuario || {};
                
                sistemaData.usuarios[matricula] = {
                    ...dadosUsuario,
                    senha: senhaHash,
                    ativo: true,
                    isAdmin: config.isAdmin,
                    primeiroAcesso: false, // Importante: marcar como false para evitar loop
                    nome: config.nome,
                    criadoEm: dadosUsuario.criadoEm || new Date(),
                    criadoPor: dadosUsuario.criadoPor || 'primeiro_acesso',
                    senhaDefinidaEm: new Date()
                };
                
                // Salvar imediatamente para evitar perda de dados
                salvarDados();

                alert('‚úÖ Senha definida com sucesso! Fazendo login...');
            } else {
                // Login normal - verificar senha
                if (!senha) {
                    alert('‚ùå Digite sua senha!');
                    return;
                }

                const senhaHash = CryptoJS.SHA256(senha).toString();
                if (usuario.senha !== senhaHash) {
                    alert('‚ùå Senha incorreta!');
                    return;
                }
            }

            if (!sistemaData.usuarios[matricula].ativo) {
                alert('‚ùå Usu√°rio inativo. Entre em contato com o administrador.');
                return;
            }

            // Verificar se usu√°rio n√£o-admin tem evento ativo
            if (!sistemaData.usuarios[matricula].isAdmin && !sistemaData.eventoAtivo) {
                alert('‚ö†Ô∏è Nenhum evento de blitz ativo. Aguarde o administrador criar um evento.');
                return;
            }

            sistemaData.usuarioLogado = {
                matricula: matricula,
                isAdmin: sistemaData.usuarios[matricula].isAdmin
            };

            mostrarDashboard();
        }

        // Fun√ß√£o de logout
        function logout() {
            sistemaData.usuarioLogado = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('matricula').value = '';
            document.getElementById('senha').value = '';
        }

        // Mostrar dashboard ap√≥s login
        function mostrarDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            const userInfo = document.getElementById('userInfo');
            const eventStatus = document.getElementById('eventStatus');

            userInfo.textContent = `Matr√≠cula: ${sistemaData.usuarioLogado.matricula}`;
            
            if (sistemaData.usuarioLogado.isAdmin) {
                userInfo.textContent += ' (üëë Administrador)';
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('userPanel').classList.add('hidden');
                carregarEstatisticas();
                carregarUsuarios();
                carregarMatriculasDisponiveis();
                carregarEventosAtivos();
            } else {
                userInfo.textContent += ' (üëÆ Operador)';
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                carregarArtigosCTB();
                mostrarEventoAtual();
                carregarAbordagens();
            }

            atualizarStatusEvento();
        }

        // Atualizar status do evento
        function atualizarStatusEvento() {
            const eventStatus = document.getElementById('eventStatus');
            if (sistemaData.eventoAtivo) {
                eventStatus.textContent = `‚úÖ Evento Ativo: ${sistemaData.eventoAtivo.nome}`;
                eventStatus.className = 'badge status-active';
            } else {
                eventStatus.textContent = '‚ùå Nenhum evento ativo';
                eventStatus.className = 'badge status-inactive';
            }
        }

        // Carregar estat√≠sticas (admin)
        function carregarEstatisticas() {
            const totalUsuarios = Object.keys(sistemaData.usuarios).length;
            const totalEventos = sistemaData.eventos.length;
            const totalAbordagens = sistemaData.abordagens.length;

            document.getElementById('totalUsuarios').textContent = totalUsuarios;
            document.getElementById('totalEventos').textContent = totalEventos;
            document.getElementById('totalAbordagens').textContent = totalAbordagens;
        }

        // Cadastrar novo usu√°rio
        function cadastrarUsuario() {
            const matricula = document.getElementById('novaMatricula').value.trim();

            if (!matricula) {
                alert('‚ùå Preencha a matr√≠cula!');
                return;
            }

            if (matricula.length < 3) {
                alert('‚ùå Matr√≠cula deve ter pelo menos 3 caracteres!');
                return;
            }

            if (sistemaData.usuarios[matricula]) {
                alert('‚ùå Matr√≠cula j√° existe!');
                return;
            }

            // Criar usu√°rio sem senha (definir√° no primeiro acesso)
            sistemaData.usuarios[matricula] = {
                senha: null,
                ativo: true,
                isAdmin: false,
                primeiroAcesso: true,
                nome: `Operador ${matricula}`,
                criadoEm: new Date(),
                criadoPor: sistemaData.usuarioLogado.matricula
            };

            // Adicionar √† lista de matr√≠culas autorizadas
            matriculasAutorizadas[matricula] = { isAdmin: false, nome: `Operador ${matricula}` };

            document.getElementById('novaMatricula').value = '';
            
            carregarUsuarios();
            carregarMatriculasDisponiveis();
            carregarEstatisticas();
            
            alert(`‚úÖ Usu√°rio ${matricula} cadastrado com sucesso!\n\nüîë O usu√°rio deve definir sua pr√≥pria senha no primeiro acesso.\n\nüí° Informe ao usu√°rio que ele deve:\n1. Acessar o sistema com sua matr√≠cula\n2. Criar uma senha de pelo menos 6 caracteres`);
        }

        // Carregar lista de usu√°rios
        function carregarUsuarios() {
            const container = document.getElementById('usuariosList');
            let html = '<h4>üë• Usu√°rios Cadastrados:</h4><table><tr><th>Matr√≠cula</th><th>Status</th><th>Tipo</th><th>Senha Definida</th><th>Criado em</th><th>A√ß√µes</th></tr>';
            
            for (let matricula in sistemaData.usuarios) {
                const usuario = sistemaData.usuarios[matricula];
                const dataCriacao = usuario.criadoEm ? new Date(usuario.criadoEm).toLocaleDateString('pt-BR') : '-';
                const senhaDefinida = usuario.senha ? '‚úÖ Sim' : 'üîë Pendente';
                const senhaClass = usuario.senha ? 'status-active' : 'status-inactive';
                
                html += `<tr>
                    <td>${matricula}</td>
                    <td class="${usuario.ativo ? 'status-active' : 'status-inactive'}">
                        ${usuario.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}
                    </td>
                    <td>${usuario.isAdmin ? 'üëë Admin' : 'üëÆ Operador'}</td>
                    <td class="${senhaClass}">${senhaDefinida}</td>
                    <td>${dataCriacao}</td>
                    <td>
                        ${matricula !== '257' ? 
                            `<button class="btn ${usuario.ativo ? 'btn-danger' : 'btn-success'}" onclick="toggleUsuario('${matricula}')">
                                ${usuario.ativo ? 'Desativar' : 'Ativar'}
                            </button>
                            ${!usuario.senha ? 
                                `<button class="btn btn-warning" onclick="resetarSenha('${matricula}')" style="margin-left: 5px;">
                                    üîÑ Resetar
                                </button>` : ''
                            }` : 
                            '<span>üîí Protegido</span>'
                        }
                    </td>
                </tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Resetar senha de usu√°rio (permite que defina nova senha no pr√≥ximo login)
        function resetarSenha(matricula) {
            const usuario = sistemaData.usuarios[matricula];
            if (!usuario) return;

            if (confirm(`üîÑ Resetar senha do usu√°rio ${matricula}?\n\nO usu√°rio precisar√° definir uma nova senha no pr√≥ximo acesso.`)) {
                usuario.senha = null;
                usuario.primeiroAcesso = true;
                usuario.senhaResetadaEm = new Date();
                usuario.senhaResetadaPor = sistemaData.usuarioLogado.matricula;
                
                carregarUsuarios();
                alert(`‚úÖ Senha resetada!\n\nO usu√°rio ${matricula} deve:\n1. Fazer login normalmente\n2. Definir uma nova senha no acesso`);
            }
        }

        // Alternar status do usu√°rio
        function toggleUsuario(matricula) {
            const usuario = sistemaData.usuarios[matricula];
            const acao = usuario.ativo ? 'desativar' : 'ativar';
            
            if (confirm(`Tem certeza que deseja ${acao} o usu√°rio ${matricula}?`)) {
                usuario.ativo = !usuario.ativo;
                carregarUsuarios();
                carregarMatriculasDisponiveis();
                alert(`‚úÖ Usu√°rio ${matricula} ${usuario.ativo ? 'ativado' : 'desativado'} com sucesso!`);
            }
        }

        // Carregar matr√≠culas dispon√≠veis para eventos
        function carregarMatriculasDisponiveis() {
            const container = document.getElementById('matriculasDisponiveis');
            let html = '';
            
            const usuariosAtivos = Object.keys(sistemaData.usuarios).filter(matricula => {
                const usuario = sistemaData.usuarios[matricula];
                return !usuario.isAdmin && usuario.ativo;
            });

            if (usuariosAtivos.length === 0) {
                html = '<p>‚ùå Nenhum operador ativo dispon√≠vel</p>';
            } else {
                usuariosAtivos.forEach(matricula => {
                    html += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="mat_${matricula}" value="${matricula}">
                            <label for="mat_${matricula}">üëÆ Matr√≠cula ${matricula}</label>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // Obter localiza√ß√£o GPS
        function obterLocalizacao() {
            const infoDiv = document.getElementById('localizacaoInfo');
            infoDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Obtendo localiza√ß√£o...</p></div>';
            infoDiv.classList.remove('hidden');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        sistemaData.localizacaoAtual = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            precisao: position.coords.accuracy,
                            timestamp: new Date()
                        };
                        
                        infoDiv.innerHTML = `
                            <h4>üìç Localiza√ß√£o GPS Obtida:</h4>
                            <p><strong>Latitude:</strong> ${position.coords.latitude.toFixed(6)}</p>
                            <p><strong>Longitude:</strong> ${position.coords.longitude.toFixed(6)}</p>
                            <p><strong>Precis√£o:</strong> ¬±${position.coords.accuracy.toFixed(0)}m</p>
                            <p><strong>Hor√°rio:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                            <p style="color: #4ade80;">‚úÖ Localiza√ß√£o capturada com sucesso!</p>
                        `;
                    },
                    function(error) {
                        let mensagemErro = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensagemErro = 'Permiss√£o de localiza√ß√£o negada pelo usu√°rio.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensagemErro = 'Informa√ß√µes de localiza√ß√£o n√£o dispon√≠veis.';
                                break;
                            case error.TIMEOUT:
                                mensagemErro = 'Tempo limite para obter localiza√ß√£o excedido.';
                                break;
                            default:
                                mensagemErro = 'Erro desconhecido ao obter localiza√ß√£o.';
                                break;
                        }
                        
                        infoDiv.innerHTML = `
                            <h4>‚ùå Erro na Geolocaliza√ß√£o:</h4>
                            <p style="color: #f87171;">${mensagemErro}</p>
                            <p>üí° Por favor, digite o local manualmente no campo abaixo.</p>
                        `;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                infoDiv.innerHTML = `
                    <h4>‚ùå Geolocaliza√ß√£o n√£o suportada</h4>
                    <p style="color: #f87171;">Seu navegador n√£o suporta geolocaliza√ß√£o.</p>
                    <p>üí° Por favor, digite o local manualmente.</p>
                `;
            }
        }

        // Criar novo evento
        function criarEvento() {
            const nome = document.getElementById('nomeBlitz').value.trim();
            const data = document.getElementById('dataBlitz').value;
            const hora = document.getElementById('horaBlitz').value;
            const local = document.getElementById('localBlitz').value.trim();
            
            if (!data || !hora) {
                alert('‚ùå Preencha data e hora da blitz!');
                return;
            }

            // Verificar se a data/hora n√£o √© no passado
            const dataHoraEvento = new Date(data + 'T' + hora);
            const agora = new Date();
            
            if (dataHoraEvento < agora) {
                alert('‚ö†Ô∏è A data e hora do evento n√£o podem ser no passado!');
                return;
            }

            const matriculasSelecionadas = [];
            const checkboxes = document.querySelectorAll('#matriculasDisponiveis input[type="checkbox"]:checked');
            checkboxes.forEach(cb => matriculasSelecionadas.push(cb.value));

            if (matriculasSelecionadas.length === 0) {
                alert('‚ùå Selecione pelo menos uma matr√≠cula para participar!');
                return;
            }

            // Encerrar evento anterior se houver
            if (sistemaData.eventoAtivo) {
                sistemaData.eventoAtivo.ativo = false;
            }

            const evento = {
                id: Date.now(),
                nome: nome,
                data: data,
                hora: hora,
                local: local || (sistemaData.localizacaoAtual ? 
                    `GPS: ${sistemaData.localizacaoAtual.latitude.toFixed(6)}, ${sistemaData.localizacaoAtual.longitude.toFixed(6)}` : 
                    'Local n√£o informado'),
                localizacao: sistemaData.localizacaoAtual,
                matriculas: matriculasSelecionadas,
                ativo: true,
                criadoPor: sistemaData.usuarioLogado.matricula,
                criadoEm: new Date(),
                abordagens: 0
            };

            sistemaData.eventos.push(evento);
            sistemaData.eventoAtivo = evento;

            // Limpar formul√°rio
            document.getElementById('dataBlitz').value = '';
            document.getElementById('horaBlitz').value = '';
            document.getElementById('localBlitz').value = '';
            document.getElementById('localizacaoInfo').classList.add('hidden');
            document.querySelectorAll('#matriculasDisponiveis input[type="checkbox"]').forEach(cb => cb.checked = false);
            sistemaData.localizacaoAtual = null;

            carregarEventosAtivos();
            carregarEstatisticas();
            atualizarStatusEvento();
            alert('‚úÖ Evento criado e ativado com sucesso!');
        }

        // Carregar eventos ativos
        function carregarEventosAtivos() {
            const container = document.getElementById('eventosAtivos');
            const eventosAtivos = sistemaData.eventos.filter(e => e.ativo);
            
            if (eventosAtivos.length === 0) {
                container.innerHTML = '<p>‚ùå Nenhum evento ativo.</p>';
                return;
            }

            let html = '<table><tr><th>Nome</th><th>Data/Hora</th><th>Local</th><th>Matr√≠culas</th><th>Abordagens</th><th>A√ß√µes</th></tr>';
            
            eventosAtivos.forEach(evento => {
                const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === evento.id).length;
                html += `<tr>
                    <td>üö® ${evento.nome}</td>
                    <td>üìÖ ${evento.data} ‚è∞ ${evento.hora}</td>
                    <td>üìç ${evento.local}</td>
                    <td>üëÆ ${evento.matriculas.join(', ')}</td>
                    <td><span class="status-active">${abordagensEvento}</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="encerrarEvento(${evento.id})">
                            ‚èπÔ∏è Encerrar
                        </button>
                    </td>
                </tr>`;
            });
            html += '</table>';
            container.innerHTML = html;
        }

        // Encerrar evento
        function encerrarEvento(eventoId) {
            const evento = sistemaData.eventos.find(e => e.id === eventoId);
            if (!evento) return;

            const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === eventoId).length;
            
            if (confirm(`üîö Tem certeza que deseja encerrar o evento "${evento.nome}"?\n\nüìä Abordagens registradas: ${abordagensEvento}\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita.`)) {
                evento.ativo = false;
                evento.encerradoEm = new Date();
                evento.encerradoPor = sistemaData.usuarioLogado.matricula;
                
                if (sistemaData.eventoAtivo && sistemaData.eventoAtivo.id === eventoId) {
                    sistemaData.eventoAtivo = null;
                }
                
                carregarEventosAtivos();
                atualizarStatusEvento();
                alert(`‚úÖ Evento "${evento.nome}" encerrado com sucesso!\nüìä Total de abordagens: ${abordagensEvento}`);
            }
        }

        // Mostrar evento atual (para operadores)
        function mostrarEventoAtual() {
            const container = document.getElementById('eventoAtualInfo');
            if (sistemaData.eventoAtivo) {
                const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === sistemaData.eventoAtivo.id).length;
                container.innerHTML = `
                    <h4>üö® Evento Ativo: ${sistemaData.eventoAtivo.nome}</h4>
                    <p><strong>üìÖ Data:</strong> ${sistemaData.eventoAtivo.data} <strong>‚è∞ Hora:</strong> ${sistemaData.eventoAtivo.hora}</p>
                    <p><strong>üìç Local:</strong> ${sistemaData.eventoAtivo.local}</p>
                    <p><strong>üëÆ Matr√≠culas Participantes:</strong> ${sistemaData.eventoAtivo.matriculas.join(', ')}</p>
                    <p><strong>üìä Abordagens Registradas:</strong> <span class="status-active">${abordagensEvento}</span></p>
                `;
            } else {
                container.innerHTML = '<p>‚ùå Nenhum evento ativo no momento.</p>';
            }
        }

        // Carregar artigos do CTB
        function carregarArtigosCTB() {
            const container = document.getElementById('artigosCTB');
            let html = '';
            
            for (let artigo in artigosCTB) {
                html += `
                    <div class="checkbox-item">
                        <input type="checkbox" id="art_${artigo}" value="${artigo}">
                        <label for="art_${artigo}">üìú Art. ${artigo} - ${artigosCTB[artigo]}</label>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Toggle se√ß√£o de autua√ß√£o
        function toggleAutuacao() {
            const foiAutuado = document.getElementById('foiAutuado').value;
            const artigosSection = document.getElementById('artigosSection');
            
            if (foiAutuado === 'sim') {
                artigosSection.classList.remove('hidden');
            } else {
                artigosSection.classList.add('hidden');
                // Desmarcar todos os artigos
                document.querySelectorAll('#artigosCTB input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        }

        // Toggle recusa de teste
        function toggleRecusaTeste() {
            const testeEtilometro = document.getElementById('testeEtilometro').value;
            const foiAutuado = document.getElementById('foiAutuado');
            const artigosSection = document.getElementById('artigosSection');
            
            if (testeEtilometro === 'recusou' || testeEtilometro === 'nao_realizado') {
                // Marcar automaticamente como autuado
                foiAutuado.value = 'sim';
                artigosSection.classList.remove('hidden');
                
                // Marcar automaticamente o artigo 165-A para recusa
                if (testeEtilometro === 'recusou') {
                    const checkbox165A = document.getElementById('art_165-A');
                    if (checkbox165A) {
                        checkbox165A.checked = true;
                    }
                }
            }
        }

        // Registrar abordagem
        function registrarAbordagem() {
            const placaVeiculo = document.getElementById('placaVeiculo').value.trim().toUpperCase();
            const cpfCondutor = document.getElementById('cpfCondutor').value.trim();
            const cnhCondutor = document.getElementById('cnhCondutor').value.trim();
            const foiAutuado = document.getElementById('foiAutuado').value;
            const testeEtilometro = document.getElementById('testeEtilometro').value;
            const veiculoRemovido = document.getElementById('veiculoRemovido').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            // Valida√ß√µes
            if (!placaVeiculo) {
                alert('‚ùå Informe a placa do ve√≠culo!');
                return;
            }

            if (!cpfCondutor && !cnhCondutor) {
                alert('‚ùå Informe pelo menos o CPF ou CNH do condutor!');
                return;
            }

            // Validar formato da placa
            const placaRegex = /^[A-Z]{3}-\d{4}$/;
            if (!placaRegex.test(placaVeiculo)) {
                alert('‚ùå Formato de placa inv√°lido! Use o formato: ABC-1234');
                return;
            }

            if (!sistemaData.eventoAtivo) {
                alert('‚ùå Nenhum evento ativo para registrar abordagem!');
                return;
            }

            // Verificar se o operador est√° autorizado para este evento
            if (!sistemaData.eventoAtivo.matriculas.includes(sistemaData.usuarioLogado.matricula)) {
                alert('‚ùå Voc√™ n√£o est√° autorizado a registrar abordagens neste evento!');
                return;
            }

            // Coletar artigos selecionados
            const artigosSelecionados = [];
            if (foiAutuado === 'sim') {
                document.querySelectorAll('#artigosCTB input[type="checkbox"]:checked').forEach(cb => {
                    artigosSelecionados.push({
                        artigo: cb.value,
                        descricao: artigosCTB[cb.value]
                    });
                });

                if (artigosSelecionados.length === 0) {
                    alert('‚ùå Se foi autuado, selecione pelo menos um artigo do CTB!');
                    return;
                }
            }

            const abordagem = {
                id: Date.now(),
                eventoId: sistemaData.eventoAtivo.id,
                placaVeiculo: placaVeiculo,
                cpfCondutor: cpfCondutor,
                cnhCondutor: cnhCondutor,
                foiAutuado: foiAutuado,
                testeEtilometro: testeEtilometro,
                veiculoRemovido: veiculoRemovido,
                artigosAplicados: artigosSelecionados,
                observacoes: observacoes,
                registradoPor: sistemaData.usuarioLogado.matricula,
                registradoEm: new Date(),
                localizacao: sistemaData.eventoAtivo.localizacao
            };

            sistemaData.abordagens.push(abordagem);

            // Limpar formul√°rio
            limparFormularioAbordagem();

            // Atualizar displays
            carregarAbordagens();
            mostrarEventoAtual();
            
            alert('‚úÖ Abordagem registrada com sucesso!');
        }

        // Limpar formul√°rio de abordagem
        function limparFormularioAbordagem() {
            document.getElementById('placaVeiculo').value = '';
            document.getElementById('cpfCondutor').value = '';
            document.getElementById('cnhCondutor').value = '';
            document.getElementById('foiAutuado').value = 'nao';
            document.getElementById('testeEtilometro').value = 'nao_realizado';
            document.getElementById('veiculoRemovido').value = 'nao';
            document.getElementById('observacoes').value = '';
            document.getElementById('artigosSection').classList.add('hidden');
            document.querySelectorAll('#artigosCTB input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // Carregar abordagens do evento atual
        function carregarAbordagens() {
            const container = document.getElementById('abordagensLista');
            
            if (!sistemaData.eventoAtivo) {
                container.innerHTML = '<p>‚ùå Nenhum evento ativo.</p>';
                return;
            }

            const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === sistemaData.eventoAtivo.id);
            
            if (abordagensEvento.length === 0) {
                container.innerHTML = '<p>üìù Nenhuma abordagem registrada neste evento ainda.</p>';
                return;
            }

            // Estat√≠sticas r√°pidas
            const totalAutuados = abordagensEvento.filter(a => a.foiAutuado === 'sim').length;
            const totalTestesPositivos = abordagensEvento.filter(a => a.testeEtilometro === 'realizado_positivo').length;
            const totalRecusas = abordagensEvento.filter(a => a.testeEtilometro === 'recusou').length;
            const totalRemocoes = abordagensEvento.filter(a => a.veiculoRemovido === 'sim').length;

            let html = `
                <div class="stats-section" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stats-card">
                        <div class="stats-number">${abordagensEvento.length}</div>
                        <div>Total</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">${totalAutuados}</div>
                        <div>Autuados</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">${totalTestesPositivos}</div>
                        <div>Testes +</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">${totalRecusas}</div>
                        <div>Recusas</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-number">${totalRemocoes}</div>
                        <div>Remo√ß√µes</div>
                    </div>
                </div>
                
                <table>
                    <tr>
                        <th>Placa</th>
                        <th>Condutor</th>
                        <th>Autuado</th>
                        <th>Etil√¥metro</th>
                        <th>Removido</th>
                        <th>Operador</th>
                        <th>Data/Hora</th>
                        <th>A√ß√µes</th>
                    </tr>
            `;

            // Ordenar por data mais recente
            abordagensEvento.sort((a, b) => new Date(b.registradoEm) - new Date(a.registradoEm));

            abordagensEvento.forEach(abordagem => {
                const condutor = abordagem.cpfCondutor || abordagem.cnhCondutor || 'N√£o informado';
                html += `<tr>
                    <td>üöó ${abordagem.placaVeiculo}</td>
                    <td>${condutor}</td>
                    <td class="${abordagem.foiAutuado === 'sim' ? 'status-inactive' : 'status-active'}">
                        ${abordagem.foiAutuado === 'sim' ? '‚ùå Sim' : '‚úÖ N√£o'}
                    </td>
                    <td>${getTesteEtilometroIcon(abordagem.testeEtilometro)}</td>
                    <td>${abordagem.veiculoRemovido === 'sim' ? 'üöõ Sim' : '‚úÖ N√£o'}</td>
                    <td>üëÆ ${abordagem.registradoPor}</td>
                    <td>${new Date(abordagem.registradoEm).toLocaleString('pt-BR')}</td>
                    <td>
                        <button class="btn btn-primary" onclick="verDetalhes(${abordagem.id})">
                            üëÅÔ∏è Detalhes
                        </button>
                    </td>
                </tr>`;
            });

            html += '</table>';
            container.innerHTML = html;
        }

        // Obter √≠cone do teste do etil√¥metro
        function getTesteEtilometroIcon(valor) {
            switch(valor) {
                case 'nao_realizado': return '‚ö™ N√£o realizado';
                case 'realizado_negativo': return '‚úÖ Negativo';
                case 'realizado_positivo': return 'üî¥ Positivo';
                case 'recusou': return '‚ùå Recusou';
                default: return valor;
            }
        }

        // Ver detalhes da abordagem
        function verDetalhes(abordagemId) {
            const abordagem = sistemaData.abordagens.find(a => a.id === abordagemId);
            if (!abordagem) return;

            let detalhes = `üöî DETALHES DA ABORDAGEM #${abordagem.id}\n\n`;
            detalhes += `üìã INFORMA√á√ïES GERAIS:\n`;
            detalhes += `üöó Placa: ${abordagem.placaVeiculo}\n`;
            detalhes += `üë§ CPF: ${abordagem.cpfCondutor || 'N√£o informado'}\n`;
            detalhes += `üÜî CNH: ${abordagem.cnhCondutor || 'N√£o informado'}\n`;
            detalhes += `üëÆ Registrado por: Matr√≠cula ${abordagem.registradoPor}\n`;
            detalhes += `üìÖ Data/Hora: ${new Date(abordagem.registradoEm).toLocaleString('pt-BR')}\n\n`;
            
            detalhes += `‚öñÔ∏è SITUA√á√ÉO LEGAL:\n`;
            detalhes += `${abordagem.foiAutuado === 'sim' ? '‚ùå' : '‚úÖ'} Foi autuado: ${abordagem.foiAutuado === 'sim' ? 'Sim' : 'N√£o'}\n`;
            detalhes += `üç∫ Teste etil√¥metro: ${getTesteEtilometroText(abordagem.testeEtilometro)}\n`;
            detalhes += `üöõ Ve√≠culo removido: ${abordagem.veiculoRemovido === 'sim' ? 'Sim' : 'N√£o'}\n`;

            if (abordagem.artigosAplicados && abordagem.artigosAplicados.length > 0) {
                detalhes += `\nüìú ARTIGOS DO CTB APLICADOS:\n`;
                abordagem.artigosAplicados.forEach(artigo => {
                    detalhes += `‚Ä¢ Art. ${artigo.artigo} - ${artigo.descricao}\n`;
                });
            }

            if (abordagem.observacoes) {
                detalhes += `\nüí≠ OBSERVA√á√ïES:\n${abordagem.observacoes}\n`;
            }

            if (abordagem.localizacao) {
                detalhes += `\nüìç LOCALIZA√á√ÉO GPS:\n`;
                detalhes += `Latitude: ${abordagem.localizacao.latitude.toFixed(6)}\n`;
                detalhes += `Longitude: ${abordagem.localizacao.longitude.toFixed(6)}\n`;
                detalhes += `Precis√£o: ¬±${abordagem.localizacao.precisao?.toFixed(0) || 0}m\n`;
            }

            alert(detalhes);
        }

        // Obter texto do teste do etil√¥metro
        function getTesteEtilometroText(valor) {
            switch(valor) {
                case 'nao_realizado': return 'N√£o realizado';
                case 'realizado_negativo': return 'Realizado - Negativo';
                case 'realizado_positivo': return 'Realizado - Positivo';
                case 'recusou': return 'Recusou o teste';
                default: return valor;
            }
        }

        // Exportar relat√≥rio do evento atual
        function exportarRelatorio() {
            if (!sistemaData.eventoAtivo) {
                alert('‚ùå Nenhum evento ativo para gerar relat√≥rio!');
                return;
            }

            const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === sistemaData.eventoAtivo.id);
            const evento = sistemaData.eventoAtivo;
            
            let relatorio = gerarRelatorioEvento(evento, abordagensEvento);
            
            // Criar e baixar arquivo
            const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_${evento.nome.replace(/\s+/g, '_')}_${evento.data}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Relat√≥rio exportado com sucesso!');
        }

        // Exportar relat√≥rio completo
        function exportarRelatorioCompleto() {
            if (sistemaData.eventos.length === 0) {
                alert('‚ùå Nenhum evento encontrado para gerar relat√≥rio!');
                return;
            }

            let relatorioCompleto = 'üöî SISTEMA BALADA SEGURA - RELAT√ìRIO COMPLETO\n';
            relatorioCompleto += `üìÖ Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            relatorioCompleto += `üë§ Gerado por: Matr√≠cula ${sistemaData.usuarioLogado.matricula}\n`;
            relatorioCompleto += '='.repeat(80) + '\n\n';

            // Estat√≠sticas gerais
            const totalEventos = sistemaData.eventos.length;
            const totalAbordagens = sistemaData.abordagens.length;
            const totalAutuacoes = sistemaData.abordagens.filter(a => a.foiAutuado === 'sim').length;

            relatorioCompleto += 'üìä ESTAT√çSTICAS GERAIS:\n';
            relatorioCompleto += `‚Ä¢ Total de eventos criados: ${totalEventos}\n`;
            relatorioCompleto += `‚Ä¢ Total de abordagens: ${totalAbordagens}\n`;
            relatorioCompleto += `‚Ä¢ Total de autua√ß√µes: ${totalAutuacoes}\n`;
            relatorioCompleto += `‚Ä¢ Taxa de autua√ß√£o: ${totalAbordagens > 0 ? (totalAutuacoes/totalAbordagens*100).toFixed(1) : 0}%\n\n`;

            // Relat√≥rio por evento
            sistemaData.eventos.forEach((evento, index) => {
                const abordagensEvento = sistemaData.abordagens.filter(a => a.eventoId === evento.id);
                relatorioCompleto += `\n${'='.repeat(60)}\n`;
                relatorioCompleto += `EVENTO ${index + 1}/${totalEventos}\n`;
                relatorioCompleto += `${'='.repeat(60)}\n`;
                relatorioCompleto += gerarRelatorioEvento(evento, abordagensEvento);
            });

            // Criar e baixar arquivo
            const blob = new Blob([relatorioCompleto], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Relat√≥rio completo exportado com sucesso!');
        }

        // Gerar relat√≥rio de um evento espec√≠fico
        function gerarRelatorioEvento(evento, abordagensEvento) {
            let relatorio = `üö® RELAT√ìRIO DO EVENTO: ${evento.nome}\n\n`;
            
            // Informa√ß√µes do evento
            relatorio += 'üìã DADOS DO EVENTO:\n';
            relatorio += `‚Ä¢ Nome: ${evento.nome}\n`;
            relatorio += `‚Ä¢ Data: ${evento.data}\n`;
            relatorio += `‚Ä¢ Hora: ${evento.hora}\n`;
            relatorio += `‚Ä¢ Local: ${evento.local}\n`;
            relatorio += `‚Ä¢ Matr√≠culas participantes: ${evento.matriculas.join(', ')}\n`;
            relatorio += `‚Ä¢ Status: ${evento.ativo ? 'Ativo' : 'Encerrado'}\n`;
            relatorio += `‚Ä¢ Criado por: Matr√≠cula ${evento.criadoPor}\n`;
            relatorio += `‚Ä¢ Criado em: ${new Date(evento.criadoEm).toLocaleString('pt-BR')}\n`;
            
            if (evento.encerradoEm) {
                relatorio += `‚Ä¢ Encerrado por: Matr√≠cula ${evento.encerradoPor}\n`;
                relatorio += `‚Ä¢ Encerrado em: ${new Date(evento.encerradoEm).toLocaleString('pt-BR')}\n`;
            }
            
            // Estat√≠sticas do evento
            const totalAutuados = abordagensEvento.filter(a => a.foiAutuado === 'sim').length;
            const totalTestesPositivos = abordagensEvento.filter(a => a.testeEtilometro === 'realizado_positivo').length;
            const totalRecusas = abordagensEvento.filter(a => a.testeEtilometro === 'recusou').length;
            const totalRemocoes = abordagensEvento.filter(a => a.veiculoRemovido === 'sim').length;
            
            relatorio += `\nüìä ESTAT√çSTICAS DO EVENTO:\n`;
            relatorio += `‚Ä¢ Total de abordagens: ${abordagensEvento.length}\n`;
            relatorio += `‚Ä¢ Ve√≠culos autuados: ${totalAutuados}\n`;
            relatorio += `‚Ä¢ Testes positivos: ${totalTestesPositivos}\n`;
            relatorio += `‚Ä¢ Recusas de teste: ${totalRecusas}\n`;
            relatorio += `‚Ä¢ Ve√≠culos removidos: ${totalRemocoes}\n`;
            relatorio += `‚Ä¢ Taxa de autua√ß√£o: ${abordagensEvento.length > 0 ? (totalAutuados/abordagensEvento.length*100).toFixed(1) : 0}%\n`;
            
            // Detalhes das abordagens
            if (abordagensEvento.length > 0) {
                relatorio += `\nüìù DETALHES DAS ABORDAGENS:\n`;
                relatorio += '-'.repeat(80) + '\n';
                
                abordagensEvento.forEach((abordagem, index) => {
                    relatorio += `\n${index + 1}. ABORDAGEM #${abordagem.id}\n`;
                    relatorio += `   üöó Placa: ${abordagem.placaVeiculo}\n`;
                    relatorio += `   üë§ CPF: ${abordagem.cpfCondutor || 'N√£o informado'}\n`;
                    relatorio += `   üÜî CNH: ${abordagem.cnhCondutor || 'N√£o informado'}\n`;
                    relatorio += `   ${abordagem.foiAutuado === 'sim' ? '‚ùå' : '‚úÖ'} Autuado: ${abordagem.foiAutuado === 'sim' ? 'Sim' : 'N√£o'}\n`;
                    relatorio += `   üç∫ Etil√¥metro: ${getTesteEtilometroText(abordagem.testeEtilometro)}\n`;
                    relatorio += `   üöõ Removido: ${abordagem.veiculoRemovido === 'sim' ? 'Sim' : 'N√£o'}\n`;
                    
                    if (abordagem.artigosAplicados && abordagem.artigosAplicados.length > 0) {
                        relatorio += `   üìú Artigos aplicados:\n`;
                        abordagem.artigosAplicados.forEach(artigo => {
                            relatorio += `      ‚Ä¢ Art. ${artigo.artigo}: ${artigo.descricao}\n`;
                        });
                    }
                    
                    if (abordagem.observacoes) {
                        relatorio += `   üí≠ Observa√ß√µes: ${abordagem.observacoes}\n`;
                    }
                    
                    relatorio += `   üëÆ Registrado por: Matr√≠cula ${abordagem.registradoPor}\n`;
                    relatorio += `   üìÖ Data/Hora: ${new Date(abordagem.registradoEm).toLocaleString('pt-BR')}\n`;
                    
                    if (abordagem.localizacao) {
                        relatorio += `   üìç GPS: ${abordagem.localizacao.latitude.toFixed(6)}, ${abordagem.localizacao.longitude.toFixed(6)}\n`;
                    }
                    
                    relatorio += '-'.repeat(40) + '\n';
                });
            } else {
                relatorio += `\n‚ùå Nenhuma abordagem foi registrada neste evento.\n`;
            }
            
            return relatorio;
        }

        // Formata√ß√£o autom√°tica de campos
        function initializeFormatters() {
            // Formata√ß√£o de placa
            const placaInput = document.getElementById('placaVeiculo');
            if (placaInput) {
                placaInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    if (value.length > 3) {
                        value = value.substring(0, 3) + '-' + value.substring(3, 7);
                    }
                    e.target.value = value;
                });
            }

            // Formata√ß√£o de CPF
            const cpfInput = document.getElementById('cpfCondutor');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    if (value.length > 9) value = value.substring(0, 9) + '-' + value.substring(9);
                    if (value.length > 6) value = value.substring(0, 6) + '.' + value.substring(6);
                    if (value.length > 3) value = value.substring(0, 3) + '.' + value.substring(3);
                    e.target.value = value;
                });
            }

            // Definir data e hora padr√£o
            const dataInput = document.getElementById('dataBlitz');
            const horaInput = document.getElementById('horaBlitz');
            if (dataInput && horaInput) {
                const agora = new Date();
                dataInput.value = agora.toISOString().split('T')[0];
                horaInput.value = agora.toTimeString().split(':').slice(0, 2).join(':');
            }
        }

        // Fun√ß√£o para salvar dados no localStorage
        function salvarDados() {
            try {
                // Salvar dados no localStorage
                localStorage.setItem('sistemaData', JSON.stringify(sistemaData));
                console.log('üìÅ Dados salvos automaticamente:', {
                    usuarios: Object.keys(sistemaData.usuarios).length,
                    eventos: sistemaData.eventos.length,
                    abordagens: sistemaData.abordagens.length,
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error('‚ùå Erro ao salvar dados:', e);
                alert('‚ö†Ô∏è Erro ao salvar dados. Verifique o espa√ßo dispon√≠vel no navegador.');
            }
        }

        // Fun√ß√£o para carregar dados de demonstra√ß√£o
        function carregarDadosDemonstracao() {
            // Evento de exemplo
            const eventoDemo = {
                id: Date.now() - 1000000,
                nome: 'Balada Segura',
                data: new Date().toISOString().split('T')[0],
                hora: '22:00',
                local: 'Av. Principal, Centro - Torres/RS',
                matriculas: ['100', '101'],
                ativo: true,
                criadoPor: '257',
                criadoEm: new Date(Date.now() - 3600000), // 1 hora atr√°s
                abordagens: 0
            };
            
            sistemaData.eventos.push(eventoDemo);
            sistemaData.eventoAtivo = eventoDemo;
            
            // Abordagens de exemplo
            const abordagensDemo = [
                {
                    id: Date.now() - 900000,

                    eventoId: eventoDemo.id,
                    placaVeiculo: 'ABC-1234',
                    cpfCondutor: '123.456.789-00',
                    cnhCondutor: '12345678901',
                    foiAutuado: 'sim',
                    testeEtilometro: 'recusou',
                    veiculoRemovido: 'nao',
                    artigosAplicados: [
                        { artigo: '165-A', descricao: artigosCTB['165-A'] }
                    ],
                    observacoes: 'Condutor apresentava sinais de embriaguez e se recusou a fazer o teste do etil√¥metro.',
                    registradoPor: '100',
                    registradoEm: new Date(Date.now() - 900000),
                    localizacao: null
                },
                {
                    id: Date.now() - 600000,
                    eventoId: eventoDemo.id,
                    placaVeiculo: 'XYZ-5678',
                    cpfCondutor: '987.654.321-00',
                    cnhCondutor: '',
                    foiAutuado: 'sim',
                    testeEtilometro: 'realizado_positivo',
                    veiculoRemovido: 'sim',
                    artigosAplicados: [
                        { artigo: '306', descricao: artigosCTB['306'] },
                        { artigo: '218', descricao: artigosCTB['218'] }
                    ],
                    observacoes: 'Condutor avan√ßou sinal vermelho e estava em velocidade excessiva. Teste do etil√¥metro positivo.',
                    registradoPor: '101',
                    registradoEm: new Date(Date.now() - 600000),
                    localizacao: null
                },
                {
                    id: Date.now() - 300000,
                    eventoId: eventoDemo.id,
                    placaVeiculo: 'DEF-9012',
                    cpfCondutor: '',
                    cnhCondutor: '98765432109',
                    foiAutuado: 'nao',
                    testeEtilometro: 'realizado_negativo',
                    veiculoRemovido: 'nao',
                    artigosAplicados: [],
                    observacoes: 'Abordagem de rotina. Condutor s√≥brio e documenta√ß√£o em ordem.',
                    registradoPor: '100',
                    registradoEm: new Date(Date.now() - 300000),
                    localizacao: null
                }
            ];
            
            sistemaData.abordagens.push(...abordagensDemo);
        }

        // Fun√ß√£o de inicializa√ß√£o
        function inicializarSistema() {
            console.log('üöî Iniciando Sistema Balada Segura...');
            
            // Verificar se j√° existe dados no localStorage
            const dadosSalvos = localStorage.getItem('sistemaData');
            if (dadosSalvos) {
                try {
                    const dados = JSON.parse(dadosSalvos);
                    // Restaurar dados salvos
                    if (dados && dados.usuarios && Object.keys(dados.usuarios).length > 0) {
                        sistemaData = dados;
                        console.log('üìÇ Dados restaurados do armazenamento local.');
                    } else {
                        // Inicializar usu√°rios base (sem senhas)
                        inicializarUsuariosBase();
                        // Carregar dados de demonstra√ß√£o
                        carregarDadosDemonstracao();
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao restaurar dados:', e);
                    // Inicializar usu√°rios base (sem senhas)
                    inicializarUsuariosBase();
                    // Carregar dados de demonstra√ß√£o
                    carregarDadosDemonstracao();
                }
            } else {
                // Inicializar usu√°rios base (sem senhas)
                inicializarUsuariosBase();
                // Carregar dados de demonstra√ß√£o
                carregarDadosDemonstracao();
            }
            
            // Inicializar formatadores
            initializeFormatters();
            
            // Configurar salvamento autom√°tico
            setInterval(salvarDados, 30000); // A cada 30 segundos
            
            console.log('‚úÖ Sistema inicializado com sucesso!');
        }

        // Fun√ß√£o para validar CPF (opcional)
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) return false;
            
            const cpfArray = cpf.split('');
            const validator = cpfArray
                .filter((digit, index, array) => index < array.length - 2)
                .map((digit, index) => (+digit) * (cpfArray.length - 1 - index))
                .reduce((acc, step) => acc + step) % 11;
            
            return validator < 2 ? +cpfArray[9] === 0 : +cpfArray[9] === 11 - validator;
        }

        // Fun√ß√£o para gerar backup dos dados
        function gerarBackup() {
            const backup = {
                versao: '1.0',
                timestamp: new Date().toISOString(),
                geradoPor: sistemaData.usuarioLogado?.matricula || 'sistema',
                dados: {
                    usuarios: sistemaData.usuarios,
                    eventos: sistemaData.eventos,
                    abordagens: sistemaData.abordagens
                }
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_balada_segura_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup gerado com sucesso!');
        }

        // Adicionar funcionalidade de tela cheia para mobile
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Erro ao entrar em tela cheia: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Event listeners para funcionalidades extras
        document.addEventListener('DOMContentLoaded', function() {
            // Permitir login com Enter
            document.getElementById('senha').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Foco autom√°tico no campo de matr√≠cula
            document.getElementById('matricula').focus();

            // Detectar modo mobile e adicionar funcionalidades espec√≠ficas
            if (window.innerWidth <= 768) {
                document.body.style.userSelect = 'none'; // Evitar sele√ß√£o acidental
                
                // Adicionar meta tag para viewport se n√£o existir
                if (!document.querySelector('meta[name="viewport"]')) {
                    const viewport = document.createElement('meta');
                    viewport.name = 'viewport';
                    viewport.content = 'width=device-width, initial-scale=1.0, user-scalable=no';
                    document.head.appendChild(viewport);
                }
            }

            // Inicializar sistema
            inicializarSistema();
        });

        // Service Worker para funcionamento offline (conceitual)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Em produ√ß√£o, implementar service worker para cache offline
                console.log('üì± Service Worker dispon√≠vel - implementar cache offline');
            });
        }

        // Detectar perda de conex√£o
        window.addEventListener('online', function() {
            console.log('üåê Conex√£o restabelecida');
        });

        window.addEventListener('offline', function() {
            console.log('üìµ Conex√£o perdida - modo offline');
            alert('‚ö†Ô∏è Conex√£o com a internet perdida. Os dados ser√£o salvos localmente.');
        });

        // Prevenir perda de dados ao sair da p√°gina
        window.addEventListener('beforeunload', function(e) {
            if (sistemaData.usuarioLogado) {
                salvarDados();
                e.preventDefault();
                e.returnValue = 'Tem certeza que deseja sair? Dados n√£o salvos podem ser perdidos.';
                return e.returnValue;
            }
        });

        // Fun√ß√£o para limpar dados de demonstra√ß√£o (para produ√ß√£o)
        function limparDadosDemo() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover todos os dados de demonstra√ß√£o!\n\nTem certeza que deseja continuar?')) {
                sistemaData.eventos = [];
                sistemaData.abordagens = [];
                sistemaData.eventoAtivo = null;
                
                // Manter apenas estrutura base dos usu√°rios, gerando novas senhas
                const usuariosTemp = {};
                for (let matricula in sistemaData.usuarios) {
                    const usuario = sistemaData.usuarios[matricula];
                    if (usuario.isAdmin || ['257', '100', '101'].includes(matricula)) {
                        const novaSenhaTemp = gerarSenhaTemporaria();
                        usuariosTemp[matricula] = {
                            senha: CryptoJS.SHA256(novaSenhaTemp).toString(),
                            ativo: true,
                            isAdmin: usuario.isAdmin,
                            primeiroAcesso: false, // Definir como false para evitar loop
                            nome: usuario.nome || `Operador ${matricula}`,
                            senhaTemporaria: novaSenhaTemp,
                            criadoEm: new Date(),
                            criadoPor: 'sistema'
                        };
                    }
                }
                sistemaData.usuarios = usuariosTemp;
                
                // Salvar imediatamente para evitar perda de dados
                salvarDados();
                
                // Exibir novas credenciais
                let credenciais = '';
                for (let matricula in usuariosTemp) {
                    credenciais += `Matr√≠cula ${matricula}: ${usuariosTemp[matricula].senhaTemporaria}\n`;
                }
                
                alert(`‚úÖ Dados de demonstra√ß√£o removidos!\n\nüîë NOVAS CREDENCIAIS:\n${credenciais}\n‚ö†Ô∏è Anote essas senhas tempor√°rias!`);
                logout();
            }
        }

        // Fun√ß√£o de ajuda/tutorial
        function mostrarAjuda() {
            const ajuda = `
üöî SISTEMA BALADA SEGURA - GUIA R√ÅPIDO

üëë ADMINISTRADOR:
‚Ä¢ Cadastrar novos operadores (senha tempor√°ria gerada automaticamente)
‚Ä¢ Criar e encerrar eventos de blitz  
‚Ä¢ Visualizar relat√≥rios completos
‚Ä¢ Gerenciar usu√°rios do sistema
‚Ä¢ Gerar novas senhas tempor√°rias quando necess√°rio

üëÆ OPERADOR:
‚Ä¢ Registrar abordagens durante eventos
‚Ä¢ Consultar hist√≥rico de abordagens
‚Ä¢ Visualizar detalhes das ocorr√™ncias
‚Ä¢ Trocar senha no primeiro acesso

ÔøΩ SEGURAN√áA:
‚Ä¢ Senhas s√£o geradas automaticamente para novos usu√°rios
‚Ä¢ Primeiro acesso obriga troca de senha
‚Ä¢ Todas as senhas s√£o protegidas com hash SHA256
‚Ä¢ Senhas tempor√°rias s√£o exibidas apenas uma vez

ÔøΩüì± DICAS DE USO:
‚Ä¢ Use a geolocaliza√ß√£o para capturar o local automaticamente
‚Ä¢ Preencha todos os campos obrigat√≥rios
‚Ä¢ O artigo 165-A √© aplicado automaticamente em caso de recusa
‚Ä¢ Dados s√£o salvos automaticamente a cada 30 segundos

üÜò SUPORTE:
‚Ä¢ Problemas t√©cnicos: contate o administrador
‚Ä¢ D√∫vidas sobre legisla√ß√£o: consulte o CTB
‚Ä¢ Backup dos dados: fun√ß√£o dispon√≠vel no painel admin

Vers√£o: 2.0 | Desenvolvido para Torres/RS
            `.trim();
            
            alert(ajuda);
        }

        // Exportar fun√ß√µes globais para uso em produ√ß√£o
        window.sistemaBaladaSegura = {
            login,
            logout,
            salvarDados,
            gerarBackup,
            limparDadosDemo,
            mostrarAjuda,
            gerarSenhaTemporaria,
            configurarAdminManual,
            versao: '2.0'
        };

        console.log('üöî Sistema Balada Segura v2.0 carregado com sucesso!');
        console.log('ÔøΩ Sistema de senhas seguras ativado - senhas tempor√°rias ser√£o geradas automaticamente.');
        console.log('üìã As credenciais de primeiro acesso ser√£o exibidas no console e em alertas.');
        console.log('');
        console.log('üí° PARA CONFIGURAR ADMINISTRADOR MANUALMENTE:');
        console.log('   Execute: sistemaBaladaSegura.configurarAdminManual("257", "suaSenha")');
        console.log('   Isso evitar√° a gera√ß√£o autom√°tica de senhas tempor√°rias.');
        console.log('');
        console.log('üîÑ PARA RESETAR: delete localStorage.adminConfigurado e recarregue a p√°gina');
    </script>
</body>
</html>